<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini r/Place</title>
  <style>
    body, html {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #222;
      color: white;
      font-family: Arial, sans-serif;
    }
    #topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: #111;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 0 10px;
      z-index: 10;
    }
    #loginBtn, #logoutBtn {
      background: #444;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
      margin-left: 10px;
    }
    #canvas-container {
      width: 100%;
      height: 100%;
    }
    #paintMenu {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 10px;
      display: none;
      flex-direction: row;
      gap: 5px;
    }
    .colorBtn {
      width: 30px;
      height: 30px;
      border: 2px solid white;
      cursor: pointer;
    }
    #status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 10px;
      display: none;
    }
    #loginModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }
    #loginBox {
      background: #333;
      padding: 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 250px;
    }
    #loginBox input {
      padding: 5px;
    }
    #paintBtn {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: #444;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div id="userBox"></div>
    <button id="loginBtn">Login/Register</button>
  </div>

  <div id="canvas-container">
    <canvas id="placeCanvas"></canvas>
  </div>

  <div id="paintBtn">ðŸŽ¨ Pintar</div>
  <div id="paintMenu"></div>
  <div id="status">Pixels usados: <span id="used">0</span><br>Cooldown: <span id="cooldown">0</span>s</div>

  <div id="loginModal">
    <div id="loginBox">
      <h3>Login / Register</h3>
      <input type="text" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="doLogin">Login</button>
      <button id="doRegister">Register</button>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/backendless/6.6.5/backendless.min.js"></script>
<script>
  // ðŸ”¹ Configura con tus claves
  const APP_ID = "YOUR-APP-ID";
  const API_KEY = "YOUR-API-KEY";
  Backendless.initApp(APP_ID, API_KEY);

  const canvas = document.getElementById("placeCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const gridSize = 100; // lienzo 100x100
  const pixelSize = 10; // cada pixel 10x10 en escala base
  let scale = 1, offsetX = 0, offsetY = 0;
  let isDragging = false, lastX, lastY;
  let selectedColor = null;
  let usedPixels = 0, cooldown = 0;
  let currentUser = null;

  // Paleta de colores
  const colors = ["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#000000","#FFFFFF"];
  const paintMenu = document.getElementById("paintMenu");
  colors.forEach(c=>{
    const btn=document.createElement("div");
    btn.className="colorBtn";
    btn.style.background=c;
    btn.onclick=()=>{selectedColor=c;};
    paintMenu.appendChild(btn);
  });

  // Render inicial del lienzo (blanco)
  let pixels = {};
  function drawCanvas(){
    ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
    ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width/scale,canvas.height/scale);
    ctx.fillStyle="#222"; ctx.fillRect(0,0,gridSize*pixelSize,gridSize*pixelSize);
    for(let k in pixels){
      let p = pixels[k];
      ctx.fillStyle=p.color;
      ctx.fillRect(p.x*pixelSize,p.y*pixelSize,pixelSize,pixelSize);
    }
  }

  function screenToWorld(x,y){
    return {
      x: Math.floor((x-offsetX)/scale/pixelSize),
      y: Math.floor((y-offsetY)/scale/pixelSize)
    };
  }

  // Pan y zoom
  canvas.addEventListener("mousedown", e=>{isDragging=true;lastX=e.clientX;lastY=e.clientY;});
  canvas.addEventListener("mouseup", ()=>isDragging=false);
  canvas.addEventListener("mousemove", e=>{
    if(isDragging){
      offsetX += e.clientX-lastX;
      offsetY += e.clientY-lastY;
      lastX=e.clientX;lastY=e.clientY;
      drawCanvas();
    }
  });
  canvas.addEventListener("wheel", e=>{
    e.preventDefault();
    const zoom = e.deltaY<0?1.1:0.9;
    scale *= zoom;
    drawCanvas();
  });

  // Pintar pixel
  canvas.addEventListener("click", async e=>{
    if(!selectedColor || cooldown>0 || !currentUser) return;
    const pos=screenToWorld(e.clientX,e.clientY);
    if(pos.x<0||pos.y<0||pos.x>=gridSize||pos.y>=gridSize) return;
    // Guardar en Backendless
    const pixelObj={x:pos.x,y:pos.y,color:selectedColor,ownerId:currentUser.objectId};
    await Backendless.Data.of("Pixels").save(pixelObj);
    pixels[`${pos.x},${pos.y}`]=pixelObj;
    usedPixels++;
    cooldown=30;
    selectedColor=null; // desseleccionar
    updateUI();
    drawCanvas();
  });

  // Cargar pixels al inicio
  async function loadPixels(){
    const data=await Backendless.Data.of("Pixels").find();
    data.forEach(p=>pixels[`${p.x},${p.y}`]=p);
    drawCanvas();
  }
  loadPixels();

  // Cooldown timer
  setInterval(()=>{
    if(cooldown>0){cooldown--;updateUI();}
  },1000);

  // UI
  const status=document.getElementById("status");
  const paintBtn=document.getElementById("paintBtn");
  const loginBtn=document.getElementById("loginBtn");
  const loginModal=document.getElementById("loginModal");
  const doLogin=document.getElementById("doLogin");
  const doRegister=document.getElementById("doRegister");
  const userBox=document.getElementById("userBox");

  function updateUI(){
    document.getElementById("used").innerText=usedPixels;
    document.getElementById("cooldown").innerText=cooldown;
  }

  paintBtn.onclick=()=>{paintMenu.style.display=paintMenu.style.display==="flex"?"none":"flex";};

  loginBtn.onclick=()=>{loginModal.style.display="flex";};
  doLogin.onclick=async()=>{
    const email=document.getElementById("email").value;
    const pass=document.getElementById("password").value;
    currentUser=await Backendless.UserService.login(email,pass,true);
    loginModal.style.display="none";
    afterLogin();
  };
  doRegister.onclick=async()=>{
    const email=document.getElementById("email").value;
    const pass=document.getElementById("password").value;
    let user=new Backendless.User();
    user.email=email; user.password=pass;
    currentUser=await Backendless.UserService.register(user);
    loginModal.style.display="none";
    afterLogin();
  };

  function afterLogin(){
    loginBtn.style.display="none";
    paintBtn.style.display="block";
    status.style.display="block";
    userBox.innerHTML=`<b>${currentUser.email}</b>`;
  }

  drawCanvas();
</script>
</body>
</html>
